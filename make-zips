#!/bin/bash
set -euo pipefail

VERSION="1.0"
XPI_FILENAME="epa-zotero-plugin-$VERSION.xpi"
TMPL_FILENAME="updates-$VERSION.json.tmpl"
UPDATES_FILENAME="updates-$VERSION.json"

rm -rf build
mkdir build

cd ./src
if command -v zip &>/dev/null; then
    zip -r "../build/$XPI_FILENAME" *
else
    7z a -tzip -mx=9 "../build/$XPI_FILENAME" *
fi
cd ../build

# Calculate the SHA256 hash and update the JSON template
XPI_HASH=$(shasum -a 256 "$XPI_FILENAME" | cut -d' ' -f1)
jq ".addons[\"github@epa.gov\"].updates[0].update_hash = \"sha256:$XPI_HASH\"" \
    "../$TMPL_FILENAME" > $UPDATES_FILENAME
